---
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="icon" href="/favicon.ico" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>Associate Finder</title>
	</head>
	<body>
		<main class="dashboard">
			<header class="header">
				<h1 class="title">Associate Finder</h1>
			</header>

			<section class="categories" aria-label="Επιλογή κατηγορίας">
				<h2 class="section-label">Επιλέξτε κατηγορία</h2>
				<div class="category-cards" id="category-cards">
					<button type="button" class="category-card selected" data-category="videographer" id="cat-videographer">
						Videographer
					</button>
					<button type="button" class="category-card" data-category="influencer" id="cat-influencer">
						Influencer
					</button>
					<button type="button" class="category-card" data-category="model" id="cat-model">
						Models
					</button>
				</div>
			</section>

			<section class="search-section" aria-label="Αναζήτηση κατά τοποθεσία">
				<label for="location-input" class="section-label">Τοποθεσία</label>
				<div class="search-row">
					<input
						type="text"
						id="location-input"
						class="location-input"
						placeholder="π.χ. Athens, Thessaloniki"
						autocomplete="off"
					/>
					<button type="button" class="search-btn" id="search-btn">Αναζήτηση</button>
				</div>
			</section>

			<section class="results-section" aria-label="Αποτελέσματα">
				<div id="results-state" class="results-state" data-state="idle">
					<p id="results-message" class="results-message">Επιλέξτε κατηγορία και τοποθεσία και πατήστε Αναζήτηση.</p>
				</div>
				<ul id="results-list" class="results-list" hidden></ul>
			</section>
		</main>

		<style>
			:root {
				--bg: #0f0f12;
				--surface: #1a1a1f;
				--border: #2d2d35;
				--text: #e8e8ec;
				--text-muted: #9a9aa5;
				--accent: #6366f1;
				--accent-hover: #818cf8;
				--error: #f87171;
			}

			*,
			*::before,
			*::after {
				box-sizing: border-box;
			}

			body {
				margin: 0;
				font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
				background: var(--bg);
				color: var(--text);
				min-height: 100vh;
				line-height: 1.5;
			}

			.dashboard {
				max-width: 56rem;
				margin: 0 auto;
				padding: 2rem 1.5rem;
			}

			.header {
				margin-bottom: 2.5rem;
			}

			.title {
				font-size: 1.75rem;
				font-weight: 700;
				margin: 0;
				letter-spacing: -0.02em;
			}

			.section-label {
				display: block;
				font-size: 0.875rem;
				font-weight: 600;
				color: var(--text-muted);
				margin-bottom: 0.75rem;
			}

			.categories {
				margin-bottom: 2rem;
			}

			.category-cards {
				display: flex;
				flex-wrap: wrap;
				gap: 0.75rem;
			}

			.category-card {
				flex: 1 1 140px;
				padding: 1rem 1.25rem;
				background: var(--surface);
				border: 2px solid var(--border);
				border-radius: 10px;
				color: var(--text);
				font-size: 1rem;
				font-weight: 500;
				cursor: pointer;
				transition: border-color 0.2s, background 0.2s;
			}

			.category-card:hover {
				border-color: var(--accent);
				background: rgba(99, 102, 241, 0.08);
			}

			.category-card.selected {
				border-color: var(--accent);
				background: rgba(99, 102, 241, 0.15);
			}

			.search-section {
				margin-bottom: 2rem;
			}

			.search-row {
				display: flex;
				flex-wrap: wrap;
				gap: 0.75rem;
			}

			.location-input {
				flex: 1 1 200px;
				min-width: 0;
				padding: 0.75rem 1rem;
				background: var(--surface);
				border: 2px solid var(--border);
				border-radius: 8px;
				color: var(--text);
				font-size: 1rem;
			}

			.location-input::placeholder {
				color: var(--text-muted);
			}

			.location-input:focus {
				outline: none;
				border-color: var(--accent);
			}

			.search-btn {
				padding: 0.75rem 1.5rem;
				background: var(--accent);
				border: none;
				border-radius: 8px;
				color: white;
				font-size: 1rem;
				font-weight: 600;
				cursor: pointer;
				transition: background 0.2s;
			}

			.search-btn:hover {
				background: var(--accent-hover);
			}

			.results-section {
				margin-top: 2rem;
			}

			.results-state {
				padding: 1.5rem;
				background: var(--surface);
				border-radius: 10px;
				border: 1px solid var(--border);
			}

			.results-state[data-state="loading"] .results-message {
				color: var(--text-muted);
			}

			.results-state[data-state="error"] .results-message {
				color: var(--error);
			}

			.results-message {
				margin: 0;
				font-size: 0.9375rem;
			}

			.results-list {
				list-style: none;
				margin: 0;
				padding: 0;
				display: grid;
				gap: 1rem;
			}

			.results-list:not([hidden]) {
				display: grid;
			}

			.result-card {
				padding: 1.25rem;
				background: var(--surface);
				border: 1px solid var(--border);
				border-radius: 10px;
			}

			.result-card h3 {
				margin: 0 0 0.25rem 0;
				font-size: 1.125rem;
				font-weight: 600;
			}

			.result-card .location {
				font-size: 0.875rem;
				color: var(--text-muted);
				margin-bottom: 0.5rem;
			}

			.result-card .bio {
				font-size: 0.9375rem;
				color: var(--text);
				margin: 0;
			}
		</style>

		<script>
			import { collection, query, where, getDocs } from "firebase/firestore";
			import { db } from "../lib/firebase";

			type Professional = {
				id: string;
				name: string;
				location: string;
				category: string;
				bio?: string;
				imageUrl?: string;
				contact?: string;
				socialUrl?: string;
			};

			const categoryCards = document.getElementById("category-cards")!;
			const locationInput = document.getElementById("location-input") as HTMLInputElement;
			const searchBtn = document.getElementById("search-btn")!;
			const resultsState = document.getElementById("results-state")!;
			const resultsMessage = document.getElementById("results-message")!;
			const resultsList = document.getElementById("results-list") as HTMLUListElement;

			let selectedCategory = "videographer";

			function setState(state: "idle" | "loading" | "empty" | "results" | "error", message?: string) {
				resultsState.dataset.state = state;
				if (message !== undefined) resultsMessage.textContent = message;
				resultsList.hidden = state !== "results";
				resultsState.hidden = state === "results";
			}

			function renderResults(items: Professional[]) {
				resultsList.innerHTML = "";
				for (const item of items) {
					const li = document.createElement("li");
					li.className = "result-card";
					li.innerHTML = `
						<h3>${escapeHtml(item.name)}</h3>
						<p class="location">${escapeHtml(item.location)}</p>
						${item.bio ? `<p class="bio">${escapeHtml(item.bio)}</p>` : ""}
					`;
					resultsList.appendChild(li);
				}
			}

			function escapeHtml(s: string): string {
				const div = document.createElement("div");
				div.textContent = s;
				return div.innerHTML;
			}

			categoryCards.addEventListener("click", (e) => {
				const btn = (e.target as HTMLElement).closest(".category-card");
				if (!btn) return;
				selectedCategory = (btn as HTMLButtonElement).dataset.category!;
				document.querySelectorAll(".category-card").forEach((el) => el.classList.remove("selected"));
				btn.classList.add("selected");
			});

			searchBtn.addEventListener("click", async () => {
				const location = locationInput.value.trim();
				if (!location) {
					setState("idle", "Εισάγετε τοποθεσία (π.χ. Athens).");
					return;
				}

				setState("loading", "Φόρτωση αποτελεσμάτων…");
				resultsList.hidden = true;

				try {
					const col = collection(db, "professionals");
					const q = query(
						col,
						where("category", "==", selectedCategory),
						where("location", "==", location)
					);
					const snapshot = await getDocs(q);
					const items: Professional[] = snapshot.docs.map((doc) => ({
						id: doc.id,
						...doc.data(),
					})) as Professional[];

					if (items.length === 0) {
						setState("empty", `Δεν βρέθηκαν αποτελέσματα για "${location}" στην κατηγορία που επιλέξατε.`);
					} else {
						setState("results", "");
						resultsList.hidden = false;
						renderResults(items);
					}
				} catch (err) {
					const msg = err instanceof Error ? err.message : "Σφάλμα σύνδεσης. Ελέγξτε το .env και τα Firestore indexes.";
					setState("error", msg);
				}
			});
		</script>
	</body>
</html>
